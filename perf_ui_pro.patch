From efa23c13887099fe66e2b682855cd6eeaaabb8ec Mon Sep 17 00:00:00 2001
From: Ghost <ghost@admin-trading.local>
Date: Mon, 16 Feb 2026 06:37:12 -0500
Subject: [PATCH] Perf UI: pro dashboard + endpoints/copy tools

---
 perf/perf_app.py | 290 +++++++++++++++++++++++++++++++++++------------
 1 file changed, 219 insertions(+), 71 deletions(-)

diff --git a/perf/perf_app.py b/perf/perf_app.py
index 104fb49..6f83d50 100755
--- a/perf/perf_app.py
+++ b/perf/perf_app.py
@@ -3,7 +3,8 @@ import os, json, time, sqlite3, uuid
 from datetime import datetime, timezone
 from typing import Optional, Dict, Any, List
 
-from fastapi import FastAPI, HTTPException
+from fastapi import FastAPI, HTTPException, Query
+from fastapi.responses import HTMLResponse
 from pydantic import BaseModel, Field
 
 APP_DIR = os.path.dirname(os.path.abspath(__file__))
@@ -331,8 +332,6 @@ def perf_open():
     """).fetchall()
     con.close()
     return {"open": [dict(r) for r in rows]}
-from fastapi import Query
-
 @app.get("/perf/open")
 def perf_open_trades():
     con = db()
@@ -382,132 +381,281 @@ def perf_trades(
 
     con.close()
     return {"trades": [dict(r) for r in rows], "limit": limit, "filters": params}
-from fastapi.responses import HTMLResponse
 
 @app.get("/perf/ui", response_class=HTMLResponse)
 def perf_ui():
-    return """
-<!doctype html>
+    return """<!doctype html>
 <html>
 <head>
   <meta charset="utf-8"/>
+  <meta name="viewport" content="width=device-width, initial-scale=1"/>
   <title>Perf Control Center</title>
   <style>
-    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 18px; }
-    .row { display:flex; gap:14px; flex-wrap:wrap; align-items:flex-start; }
-    .card { border:1px solid #2223; border-radius:14px; padding:14px; min-width: 320px; }
-    h1 { margin:0 0 12px; font-size: 22px; }
-    h2 { margin:0 0 10px; font-size: 16px; opacity:.85; }
-    table { border-collapse: collapse; width: 100%; font-size: 13px; }
-    th, td { border-bottom:1px solid #2222; padding: 6px 8px; text-align:left; vertical-align: top; }
-    input, button { padding:8px 10px; border-radius:10px; border:1px solid #2223; }
+    :root{ --bg:#0b0d10; --fg:#e8eef7; --muted:#a6b2c2; --card:#121723; --line:#ffffff1a; --chip:#ffffff14; }
+    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 18px; background:var(--bg); color:var(--fg); }
+    a { color: inherit; }
+    .topbar { display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:14px; }
+    .title { display:flex; flex-direction:column; gap:4px; }
+    .title h1 { margin:0; font-size: 20px; letter-spacing:.2px; }
+    .subtitle { color:var(--muted); font-size: 12px; }
+    .actions { display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
+    .card { background:var(--card); border:1px solid var(--line); border-radius:16px; padding:14px; min-width: 320px; box-shadow: 0 1px 0 #0006; }
+    .card h2 { margin:0 0 10px; font-size: 14px; color:var(--muted); font-weight:600; letter-spacing:.2px; }
+    .kpis { display:grid; grid-template-columns: repeat(4, minmax(140px, 1fr)); gap:10px; }
+    .kpi { background:#0f1320; border:1px solid var(--line); border-radius:14px; padding:10px 12px; }
+    .kpi .label { color:var(--muted); font-size: 11px; }
+    .kpi .val { font-size: 16px; margin-top:6px; font-weight:700; }
+    .chip { display:inline-flex; gap:6px; align-items:center; background:var(--chip); border:1px solid var(--line); padding:6px 10px; border-radius:999px; font-size:12px; color:var(--muted); }
+    table { border-collapse: collapse; width: 100%; font-size: 12px; }
+    th, td { border-bottom:1px solid var(--line); padding: 8px 10px; text-align:left; vertical-align: top; }
+    th { color:var(--muted); font-weight:600; }
+    input, button, select { padding:8px 10px; border-radius:12px; border:1px solid var(--line); background:#0f1320; color:var(--fg); }
     button { cursor:pointer; }
-    .muted { opacity:.7; }
-    code { background:#0001; padding:2px 6px; border-radius:8px; }
+    button.primary { background:#1b4dff22; border-color:#1b4dff55; }
+    button.ghost { background:transparent; }
+    .muted { color:var(--muted); }
+    code { background:#00000033; padding:2px 6px; border:1px solid var(--line); border-radius:10px; }
+    .grid2 { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
+    .grid3 { display:grid; grid-template-columns: 1.2fr 1fr 1fr; gap:12px; }
+    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
+    .toolbar { display:flex; flex-wrap:wrap; gap:10px; align-items:flex-end; margin-bottom:10px; }
+    .field { display:flex; flex-direction:column; gap:6px; }
+    .field label { font-size:11px; color:var(--muted); }
+    .toast { position: fixed; right: 18px; bottom: 18px; background:#0f1320; border:1px solid var(--line); padding:10px 12px; border-radius:14px; display:none; }
+    @media (max-width: 1000px){ .kpis{ grid-template-columns: repeat(2, minmax(140px, 1fr)); } .grid3{ grid-template-columns: 1fr; } .grid2{ grid-template-columns: 1fr; } }
   </style>
 </head>
 <body>
-  <h1>Perf Control Center</h1>
+  <div class="topbar">
+    <div class="title">
+      <h1>Perf Control Center</h1>
+      <div class="subtitle">Dashboard LAN • API <span class="mono" id="base_url"></span> • <span id="last_updated">—</span></div>
+    </div>
+    <div class="actions">
+      <span class="chip">Status: <span id="status_badge">loading…</span></span>
+      <label class="chip"><input id="autorefresh" type="checkbox"/> auto-refresh</label>
+      <button class="primary" onclick="refreshAll(true)">Refresh</button>
+    </div>
+  </div>
+
+  <div class="card" style="margin-bottom:12px;">
+    <h2>KPIs</h2>
+    <div class="kpis">
+      <div class="kpi"><div class="label">Total trades</div><div class="val" id="k_total">—</div></div>
+      <div class="kpi"><div class="label">Open trades</div><div class="val" id="k_open">—</div></div>
+      <div class="kpi"><div class="label">PnL realized</div><div class="val" id="k_pnl">—</div></div>
+      <div class="kpi"><div class="label">Winrate / Avg R</div><div class="val" id="k_wr">—</div></div>
+    </div>
+    <div style="margin-top:10px;" class="muted">Last event: <span class="mono" id="k_last">—</span> • Max DD: <span class="mono" id="k_dd">—</span></div>
+  </div>
 
-  <div class="row">
-    <div class="card" style="flex:1">
-      <h2>Summary</h2>
-      <pre id="summary" class="muted">loading...</pre>
-      <button onclick="refreshAll()">Refresh</button>
+  <div class="grid3">
+    <div class="card">
+      <h2>Open trades</h2>
+      <div class="muted">Clique un <span class="mono">trade_id</span> pour copier + préremplir le CLOSE.</div>
+      <div style="margin-top:10px;"><table id="open_tbl"></table></div>
     </div>
 
-    <div class="card" style="flex:1">
-      <h2>Close trade</h2>
-      <div class="row">
-        <div>
-          <div class="muted">trade_id</div>
-          <input id="close_id" style="width:360px" placeholder="T_..."/>
+    <div class="card">
+      <h2>Trade actions</h2>
+      <div class="toolbar">
+        <div class="field" style="flex:1">
+          <label>trade_id</label>
+          <input id="close_id" placeholder="T_..."/>
         </div>
-        <div>
-          <div class="muted">exit</div>
-          <input id="close_exit" style="width:140px" placeholder="5038.5"/>
+        <div class="field">
+          <label>exit</label>
+          <input id="close_exit" placeholder="5038.5"/>
+        </div>
+        <div class="field">
+          <label>&nbsp;</label>
+          <button class="primary" onclick="closeTrade()">Send CLOSE</button>
         </div>
       </div>
-      <div style="margin-top:10px;">
-        <button onclick="closeTrade()">Send CLOSE</button>
-        <span id="close_res" class="muted"></span>
-      </div>
+      <div class="muted" id="close_res">—</div>
+      <div style="margin-top:12px;" class="muted">Tip: l’input <span class="mono">exit</span> doit être rempli (le placeholder n’est jamais envoyé).</div>
     </div>
-  </div>
 
-  <div class="row" style="margin-top:14px;">
-    <div class="card" style="flex:1">
-      <h2>Open trades</h2>
-      <div class="muted">Tip: clique un trade_id pour le copier.</div>
-      <table id="open_tbl"></table>
+    <div class="card">
+      <h2>Commandes utiles</h2>
+      <div class="muted">Endpoints perf + checks “PASS”.</div>
+      <div style="margin-top:10px;" class="mono" id="cmds"></div>
     </div>
+  </div>
 
-    <div class="card" style="flex:1">
-      <h2>Last trades</h2>
+  <div class="grid2" style="margin-top:12px;">
+    <div class="card">
+      <h2>Trades</h2>
+      <div class="toolbar">
+        <div class="field">
+          <label>limit</label>
+          <select id="f_limit"><option>20</option><option selected>50</option><option>100</option><option>200</option></select>
+        </div>
+        <div class="field" style="flex:1">
+          <label>engine</label>
+          <input id="f_engine" placeholder="XAU_M5_SCALP"/>
+        </div>
+        <div class="field">
+          <label>status</label>
+          <select id="f_status"><option value="" selected>ALL</option><option value="OPEN">OPEN</option><option value="CLOSED">CLOSED</option></select>
+        </div>
+        <div class="field" style="flex:1">
+          <label>symbol</label>
+          <input id="f_symbol" placeholder="XAUUSD"/>
+        </div>
+        <div class="field">
+          <label>&nbsp;</label>
+          <button class="ghost" onclick="refreshTrades()">Apply</button>
+        </div>
+      </div>
       <table id="trades_tbl"></table>
     </div>
+
+    <div class="card">
+      <h2>Raw summary (JSON)</h2>
+      <pre id="summary" class="muted">loading…</pre>
+    </div>
   </div>
 
+  <div id="toast" class="toast"></div>
+
 <script>
-async function jget(url){ const r=await fetch(url); return await r.json(); }
+const ORIGIN = window.location.origin;
+document.getElementById('base_url').textContent = ORIGIN;
+
+async function jget(url){ const r=await fetch(url); if(!r.ok) throw new Error(`${r.status} ${r.statusText}`); return await r.json(); }
 function esc(s){ return (s??"").toString().replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }
 function mkRow(cells){ return "<tr>"+cells.map(c=>"<td>"+c+"</td>").join("")+"</tr>"; }
-function copyText(t){ navigator.clipboard.writeText(t); }
+function toast(msg){ const el=document.getElementById('toast'); el.textContent=msg; el.style.display='block'; clearTimeout(window.__toast_t); window.__toast_t=setTimeout(()=>{ el.style.display='none'; },1600); }
+async function copyText(t){ await navigator.clipboard.writeText(t); toast('Copied'); }
+function fmt(n, d=2){ if(n===null||n===undefined||n==='') return '—'; const x=Number(n); if(!isFinite(x)) return String(n); return x.toFixed(d); }
+function setStatus(ok){ const el=document.getElementById('status_badge'); el.textContent=ok?'OK':'DOWN'; el.style.color=ok?'#7dffbf':'#ff7d7d'; }
+
+function buildCmds(){
+  const base = ORIGIN;
+  const items = [
+    {label:'Open', url: base + '/perf/open', curl:`curl -s ${base}/perf/open | python -m json.tool`},
+    {label:'Trades (limit=5)', url: base + '/perf/trades?limit=5', curl:`curl -s \"${base}/perf/trades?limit=5\" | python -m json.tool`},
+    {label:'Summary', url: base + '/perf/summary', curl:`curl -s ${base}/perf/summary | python -m json.tool`},
+    {label:'UI', url: base + '/perf/ui', curl:`curl -sf ${base}/perf/ui >/dev/null && echo \"UI: PASS\" || echo \"UI: FAIL\"`},
+    {label:'POST event (CLOSE)', url: base + '/perf/event', curl:`curl -s ${base}/perf/event -H \"Content-Type: application/json\" -d '{\"type\":\"CLOSE\",\"trade_id\":\"T_...\",\"exit\":5038.5}' | python -m json.tool`},
+  ];
+  let html = '';
+  for(const it of items){
+    const u = esc(it.url);
+    const c = esc(it.curl);
+    const safeCmd = it.curl.replaceAll('`','\\`');
+    html += `
+      <div style="margin-bottom:10px; padding:10px; border:1px solid var(--line); border-radius:14px; background:#0f1320;">
+        <div style="display:flex; justify-content:space-between; gap:10px; align-items:center;">
+          <div><strong>${esc(it.label)}</strong> <span class="muted mono">${u}</span></div>
+          <div style="display:flex; gap:8px;">
+            <button class="ghost" onclick="window.open('${u}','_blank')">Open</button>
+            <button class="ghost" onclick="copyText('${u}')">Copy URL</button>
+          </div>
+        </div>
+        <div style="margin-top:8px;"><code class="mono">${c}</code></div>
+        <div style="margin-top:8px;"><button class="ghost" onclick="copyText(\`${safeCmd}\`)">Copy cmd</button></div>
+      </div>
+    `;
+  }
+  document.getElementById('cmds').innerHTML = html;
+}
 
-async function refreshAll(){
-  const s = await jget("/perf/summary");
-  document.getElementById("summary").textContent = JSON.stringify(s, null, 2);
+function fillKpis(s){
+  document.getElementById('k_total').textContent = String(s.total_trades ?? '—');
+  document.getElementById('k_open').textContent = String(s.open_trades ?? '—');
+  document.getElementById('k_pnl').textContent = fmt(s.pnl_realized, 2);
+  document.getElementById('k_wr').textContent = `${fmt(s.winrate_pct, 1)}% / ${fmt(s.avg_r, 3)}`;
+  document.getElementById('k_last').textContent = (s.last_event_ts ?? '—');
+  document.getElementById('k_dd').textContent = `${fmt(s.max_dd_pct, 2)}% (${fmt(s.max_dd, 2)})`;
+}
 
-  const o = await jget("/perf/open");
+async function refreshOpen(){
+  const o = await jget('/perf/open');
   const open = o.open || [];
-  let h = "<tr><th>trade_id</th><th>engine</th><th>symbol</th><th>side</th><th>entry</th><th>stop</th><th>qty</th><th>risk</th><th>ts</th></tr>";
+  let h = '<tr><th>trade_id</th><th>engine</th><th>symbol</th><th>side</th><th>entry</th><th>stop</th><th>qty</th><th>risk</th><th>ts</th></tr>';
   for(const t of open){
     const id = esc(t.trade_id);
     h += mkRow([
-      `<a href="#" onclick="copyText('${id}'); document.getElementById('close_id').value='${id}'; return false;"><code>${id}</code></a>`,
+      `<a href="#" onclick="copyText('${id}'); document.getElementById('close_id').value='${id}'; return false;"><code class="mono">${id}</code></a>`,
       esc(t.engine), esc(t.symbol), esc(t.side),
       esc(t.entry), esc(t.stop), esc(t.qty), esc(t.risk_usd),
       esc(t.entry_ts)
     ]);
   }
-  document.getElementById("open_tbl").innerHTML = h;
+  document.getElementById('open_tbl').innerHTML = h;
+}
 
-  const tr = await jget("/perf/trades?limit=50");
+function tradesUrl(){
+  const limit = document.getElementById('f_limit').value;
+  const engine = document.getElementById('f_engine').value.trim();
+  const status = document.getElementById('f_status').value.trim();
+  const symbol = document.getElementById('f_symbol').value.trim();
+  const p = new URLSearchParams({limit});
+  if(engine) p.set('engine', engine);
+  if(status) p.set('status', status);
+  if(symbol) p.set('symbol', symbol);
+  return '/perf/trades?' + p.toString();
+}
+
+async function refreshTrades(){
+  const tr = await jget(tradesUrl());
   const trades = tr.trades || [];
-  let ht = "<tr><th>trade_id</th><th>status</th><th>engine</th><th>side</th><th>entry</th><th>exit</th><th>pnl</th><th>R</th><th>ts</th></tr>";
-  for(const t of trades.slice(0,50)){
+  let ht = '<tr><th>trade_id</th><th>status</th><th>engine</th><th>symbol</th><th>side</th><th>entry</th><th>exit</th><th>pnl</th><th>R</th><th>entry_ts</th></tr>';
+  for(const t of trades){
     const id = esc(t.trade_id);
     ht += mkRow([
-      `<code>${id}</code>`,
-      esc(t.status), esc(t.engine), esc(t.side),
-      esc(t.entry), esc(t.exit ?? ""),
-      esc(t.pnl_real ?? ""), esc(t.r_real ?? ""),
+      `<a href="#" onclick="copyText('${id}'); return false;"><code class="mono">${id}</code></a>`,
+      esc(t.status), esc(t.engine), esc(t.symbol), esc(t.side),
+      esc(t.entry), esc(t.exit ?? ''),
+      esc(t.pnl_real ?? ''), esc(t.r_real ?? ''),
       esc(t.entry_ts)
     ]);
   }
-  document.getElementById("trades_tbl").innerHTML = ht;
+  document.getElementById('trades_tbl').innerHTML = ht;
+}
+
+async function refreshAll(manual=false){
+  try{
+    const s = await jget('/perf/summary');
+    document.getElementById('summary').textContent = JSON.stringify(s, null, 2);
+    fillKpis(s);
+    await refreshOpen();
+    await refreshTrades();
+    setStatus(true);
+    document.getElementById('last_updated').textContent = 'updated ' + new Date().toLocaleString();
+    if(manual) toast('Refreshed');
+  }catch(e){
+    setStatus(false);
+    document.getElementById('last_updated').textContent = 'error ' + new Date().toLocaleString();
+    document.getElementById('summary').textContent = 'ERROR: ' + (e?.message || e);
+  }
 }
 
 async function closeTrade(){
-  const id = document.getElementById("close_id").value.trim();
-  const exitEl = document.getElementById("close_exit");
-  const exStr = ((exitEl && exitEl.value) ? exitEl.value : (exitEl ? exitEl.placeholder : "")).trim();
+  const id = document.getElementById('close_id').value.trim();
+  const exStr = document.getElementById('close_exit').value.trim();
   const ex = parseFloat(exStr);
   if(!id || !isFinite(ex)){
-    document.getElementById("close_res").textContent = "missing trade_id or exit (tip: type an exit price; placeholder is not sent)";
+    document.getElementById('close_res').textContent = 'missing trade_id or exit';
+    toast('Missing fields');
     return;
   }
-  const r = await fetch("/perf/event", {
-    method:"POST",
-    headers:{ "Content-Type":"application/json" },
-    body: JSON.stringify({type:"CLOSE", trade_id:id, exit:ex})
+  const r = await fetch('/perf/event', {
+    method:'POST',
+    headers:{ 'Content-Type':'application/json' },
+    body: JSON.stringify({type:'CLOSE', trade_id:id, exit:ex})
   });
   const j = await r.json();
-  document.getElementById("close_res").textContent = " → " + JSON.stringify(j);
-  await refreshAll();
+  document.getElementById('close_res').textContent = JSON.stringify(j);
+  toast('CLOSE sent');
+  await refreshAll(false);
 }
 
-refreshAll();
+buildCmds();
+refreshAll(false);
+setInterval(()=>{ if(document.getElementById('autorefresh').checked) refreshAll(false); }, 5000);
 </script>
 </body>
 </html>
-- 
2.39.5

